<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—‹è½‰é«”é«”ç©è¦–è¦ºåŒ–</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        #container { width: 100vw; height: 100vh; position: relative; }
        
        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 25px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 420px; max-height: 90vh; overflow-y: auto;
            z-index: 100; transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #controls.collapsed { transform: translateX(-390px); opacity: 0.3; }
        #controls.collapsed:hover { opacity: 0.6; }
        
        #toggleBtn {
            position: absolute; right: -45px; top: 20px;
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; border-radius: 0 8px 8px 0;
            color: white; font-size: 20px; cursor: pointer;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        
        h1 { color: #667eea; margin-bottom: 8px; font-size: 24px; }
        .subtitle { color: #666; font-size: 13px; margin-bottom: 20px; }
        
        .method-selector, .axis-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .method-btn, .axis-btn {
            padding: 12px; background: #f0f0f0; border: 2px solid #ddd;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
            font-size: 13px; font-weight: 600; text-align: center;
        }
        .method-btn.active, .axis-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-color: #667eea;
        }
        
        label { display: block; margin: 15px 0 5px; font-weight: 600; color: #333; font-size: 14px; }
        input[type="text"] {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 14px; font-family: 'Courier New', monospace; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #667eea; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        button.main-btn {
            width: 100%; padding: 14px; margin-top: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            cursor: pointer; font-size: 16px; font-weight: 600;
            transition: transform 0.2s;
        }
        button.main-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        
        .result {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 20px; border-radius: 10px;
            margin-top: 20px; text-align: center;
        }
        .result .value { font-size: 28px; font-weight: bold; margin: 8px 0; }
        .formula {
            font-family: 'Times New Roman', serif; background: rgba(255,255,255,0.2);
            padding: 8px; border-radius: 5px; font-size: 14px; margin-top: 8px;
        }
        
        .examples { background: #f3e5f5; padding: 12px; border-radius: 8px; margin: 15px 0; }
        .examples h4 { color: #6a1b9a; font-size: 13px; margin-bottom: 8px; }
        .example-btn {
            display: inline-block; padding: 6px 12px; margin: 4px;
            background: white; border: 2px solid #9c27b0; border-radius: 6px;
            cursor: pointer; font-size: 11px; font-weight: 600; color: #6a1b9a;
        }
        .example-btn:hover { background: #9c27b0; color: white; }
        
        .error {
            background: #ffebee; color: #c62828; padding: 10px;
            border-radius: 6px; margin-top: 10px; font-size: 12px; border: 2px solid #ef5350;
        }
        
        /* å‹•ç•«æ§åˆ¶ */
        .animation-controls {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #4caf50;
        }
        .animation-controls h4 { color: #2e7d32; font-size: 15px; margin-bottom: 12px; }
        .animation-progress { background: #fff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 2px solid #81c784; }
        .progress-bar { width: 100%; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden; margin: 8px 0; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #4caf50 0%, #81c784 100%);
            transition: width 0.1s linear; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 12px;
        }
        .anim-btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .anim-btn { padding: 8px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px; }
        .play { background: #4caf50; color: white; } .pause { background: #ff9800; color: white; }
        .stop { background: #f44336; color: white; } .reset { background: #9e9e9e; color: white; }
        .anim-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type="range"] { width: 100%; margin-top: 5px; }

        /* å³ä¸‹è§’èªªæ˜é¢æ¿ (å¯ç¸®å°) */
        #info-container {
            position: absolute; bottom: 20px; right: 20px; z-index: 101;
            display: flex; flex-direction: column; align-items: flex-end;
        }
        #info-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            font-size: 13px; color: #333; max-width: 350px;
            line-height: 1.8; transition: all 0.3s ease; transform-origin: bottom right;
        }
        #info-panel.hidden { opacity: 0; transform: scale(0.9) translateY(20px); pointer-events: none; display: none; }
        #infoToggleBtn {
            width: 36px; height: 36px; background: white; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: none;
            font-size: 18px; font-weight: bold; color: #667eea;
            cursor: pointer; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="controls">
        <button id="toggleBtn" onclick="toggleControls()">â—€</button>
        
        <h1>ğŸ¯ æ—‹è½‰é«”é«”ç©è¨ˆç®—å™¨</h1>
        <p class="subtitle">Volume of Solid of Revolution</p>
        
        <div class="examples">
            <h4>ğŸ“š èª²æœ¬ä¾‹é¡Œï¼š</h4>
            <span class="example-btn" onclick="loadExample(0)">é¡Œ23: çƒé«” (x)</span>
            <span class="example-btn" onclick="loadExample(1)">é¡Œ20: sinÂ·cos (x)</span>
            <span class="example-btn" onclick="loadExample(2)">é¡Œ40: Washer (y)</span>
            <span class="example-btn" onclick="loadExample(3)">é¡Œ45: Washer (x)</span>
        </div>
        
        <label>1. é¸æ“‡æ—‹è½‰è»¸ (è®Šæ•¸)ï¼š</label>
        <div class="axis-selector">
            <div class="axis-btn active" onclick="setAxis('x')">x è»¸ (dx)</div>
            <div class="axis-btn" onclick="setAxis('y')">y è»¸ (dy)</div>
        </div>

        <label>2. é¸æ“‡æ–¹æ³•ï¼š</label>
        <div class="method-selector">
            <div class="method-btn active" onclick="setMethod('disk')">
                Disk (åœ“ç›¤)
                <div style="font-size:10px; font-weight:normal; opacity:0.8">å¯¦å¿ƒ (r=0)</div>
            </div>
            <div class="method-btn" onclick="setMethod('washer')">
                Washer (å¢Šåœˆ)
                <div style="font-size:10px; font-weight:normal; opacity:0.8">ç©ºå¿ƒ</div>
            </div>
        </div>
        
        <label id="outerLabel">å¤–åŠå¾‘ R(x) =</label>
        <input type="text" id="outerFunc" value="sqrt(x)" placeholder="å‡½æ•¸è¡¨é”å¼">
        
        <label id="innerLabel" style="display:none;">å…§åŠå¾‘ r(x) =</label>
        <input type="text" id="innerFunc" value="0" placeholder="0" style="display:none;">
        
        <div class="grid-2">
            <div><label id="lbLabel">ä¸‹ç•Œ a =</label><input type="text" id="lowerBound" value="0"></div>
            <div><label id="ubLabel">ä¸Šç•Œ b =</label><input type="text" id="upperBound" value="4"></div>
        </div>
        
        <label>è§£æåº¦ (åœ“ç›¤æ•¸)ï¼š<span id="resValue">40</span></label>
        <input type="range" id="resolution" min="20" max="100" value="40" oninput="updateResolution(this.value)">
        
        <button class="main-btn" onclick="generateSolid()">ğŸ”„ ç”Ÿæˆå®Œæ•´æ—‹è½‰é«”</button>
        
        <div class="animation-controls">
            <h4>ğŸ¬ å‹•ç•«æ¼”ç¤º</h4>
            <div class="animation-progress" id="animProgress" style="display:none;">
                <div style="font-size: 11px; color: #555; margin-bottom: 5px;">
                    å †ç–Šé€²åº¦ï¼š<strong id="currentSlices">0</strong> / <strong id="totalSlices">40</strong>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%;">0%</div></div>
            </div>
            <div class="anim-btn-group">
                <button class="anim-btn play" onclick="startAnimation()">â–¶ æ’­æ”¾</button>
                <button class="anim-btn pause" onclick="pauseAnimation()" disabled>â¸ æš«åœ</button>
                <button class="anim-btn stop" onclick="stopAnimation()" disabled>â¹ åœæ­¢</button>
                <button class="anim-btn reset" onclick="resetAnimation()">â†º é‡ç½®</button>
            </div>
            <div class="speed-control" style="margin-top:10px">
                <label>å‹•ç•«é€Ÿåº¦ï¼š<span id="speedValue">ä¸­é€Ÿ</span></label>
                <input type="range" id="animSpeed" min="1" max="5" value="3" oninput="updateSpeed(this.value)">
            </div>
        </div>
        
        <div id="errorMsg" class="error" style="display:none;"></div>
        
        <div class="result" id="result" style="display:none;">
            <h3>å®šç©åˆ†è¨ˆç®—çµæœ</h3>
            <div class="value">V = <span id="volumeValue">0</span></div>
            <div class="formula" id="formulaDisplay"></div>
        </div>
    </div>
    
    <div id="info-container">
        <button id="infoToggleBtn" onclick="toggleInfoPanel()">?</button>
        <div id="info-panel">
            <strong>ğŸ¨ æ“ä½œèªªæ˜</strong><br>
            <strong>å–®æŒ‡æ‹–æ›³ / æ»‘é¼ å·¦éµï¼š</strong>æ—‹è½‰è¦–è§’<br>
            <strong>é›™æŒ‡æåˆ / æ»¾è¼ªï¼š</strong>ç¸®æ”¾ç•«é¢<br>
            <strong>é›™æŒ‡æ‹–æ›³ / æ»‘é¼ å³éµï¼š</strong>å¹³ç§»ç•«é¢<br>
            <br>
            <strong>ğŸ’¡ å­¸ç¿’é‡é»ï¼š</strong><br>
            â€¢ è§€å¯Ÿåˆ‡ç‰‡åšåº¦ <br>
            â€¢ <strong>Disk Method:</strong><br> $$V = \int \pi [R(x)]^2 dx$$<br>
            â€¢ <strong>Washer Method:</strong><br> $$V = \int \pi ([R(x)]^2 - [r(x)]^2) dx$$
        </div>
    </div>

    <script>
        let scene, camera, renderer, solid, controls;
        let currentMethod = 'disk';
        let currentAxis = 'x';
        let controlsCollapsed = false;
        
        let isAnimating = false;
        let animationPaused = false;
        let currentSliceCount = 0;
        let animationSpeed = 50;
        let animationInterval = null;
        let cachedSolidData = null;
        
        const examples = [
            { outer: 'sqrt(9-x^2)', inner: '0', a: '-3', b: '3', method: 'disk', axis: 'x', exact: '36Ï€', val: 36 * Math.PI },
            { outer: 'sin(x)*cos(x)', inner: '0', a: '0', b: 'pi/2', method: 'disk', axis: 'x', exact: 'Ï€Â²/16', val: Math.pow(Math.PI, 2) / 16 },
            { outer: '1', inner: 'tan(y)', a: '0', b: 'pi/4', method: 'washer', axis: 'y', exact: 'Ï€Â²/2 - Ï€', val: (Math.pow(Math.PI, 2)/2) - Math.PI },
            { outer: 'sqrt(2)', inner: 'sec(x)', a: '-pi/4', b: 'pi/4', method: 'washer', axis: 'x', exact: 'Ï€Â² - 2Ï€', val: Math.pow(Math.PI, 2) - 2 * Math.PI }
        ];
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f4f8);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(8, 6, 8);
            camera.lookAt(0, 0, 0);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('container').appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(10, 10, 10); scene.add(dl);
            
            addAxes();
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            animate();
            generateSolid();
        }
        
        function toggleControls() {
            const c = document.getElementById('controls');
            document.getElementById('toggleBtn').textContent = (c.classList.toggle('collapsed')) ? 'â–¶' : 'â—€';
        }
        function toggleInfoPanel() { document.getElementById('info-panel').classList.toggle('hidden'); }

        function setAxis(axis) {
            currentAxis = axis;
            document.querySelectorAll('.axis-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const v = axis;
            document.getElementById('outerLabel').textContent = `å¤–åŠå¾‘ R(${v}) =`;
            document.getElementById('innerLabel').textContent = `å…§åŠå¾‘ r(${v}) =`;
            document.getElementById('lbLabel').textContent = `ä¸‹ç•Œ ${v === 'x' ? 'a' : 'c'} =`;
            document.getElementById('ubLabel').textContent = `ä¸Šç•Œ ${v === 'x' ? 'b' : 'd'} =`;
        }

        function setMethod(method) {
            currentMethod = method;
            document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const disp = method === 'washer' ? 'block' : 'none';
            document.getElementById('innerLabel').style.display = disp;
            document.getElementById('innerFunc').style.display = disp;
        }
        
        function updateResolution(val) {
            document.getElementById('resValue').textContent = val;
            document.getElementById('totalSlices').textContent = val;
        }
        function updateProgress(curr, total) {
            document.getElementById('currentSlices').textContent = curr;
            document.getElementById('totalSlices').textContent = total;
            
            // è¨ˆç®—ç™¾åˆ†æ¯”
            const percent = Math.round((curr / total) * 100);
            
            // æ›´æ–°å¯¬åº¦ (ç¶ è‰²æ¢)
            document.getElementById('progressFill').style.width = percent + '%';
            
            // --- ä¿®æ­£é—œéµï¼šæ›´æ–°æ–‡å­— (è®“ 0% è®Šæˆ 100%) ---
            document.getElementById('progressFill').textContent = percent + '%';
        }
        function updateSpeed(val) {
            const ms = [200, 100, 50, 25, 10];
            const txt = ['æ¥µæ…¢', 'æ…¢é€Ÿ', 'ä¸­é€Ÿ', 'å¿«é€Ÿ', 'æ¥µå¿«'];
            document.getElementById('speedValue').textContent = txt[val-1];
            animationSpeed = ms[val-1];
        }

        function evaluateFunction(expr, value) {
            try {
                const scope = { x: value, y: value, e: Math.E, pi: Math.PI };
                let clean = expr.toLowerCase().replace(/ln\(/g, 'log(');
                return math.evaluate(clean, scope);
            } catch (e) { throw new Error('ç„¡æ³•è¨ˆç®—: ' + expr); }
        }
        
        function parseBoundary(str) {
            try { return math.evaluate(str.toLowerCase().replace(/pi/g, Math.PI).replace(/e/g, Math.E)); }
            catch(e) { throw new Error('é‚Šç•ŒéŒ¯èª¤'); }
        }

        function loadExample(idx) {
            const ex = examples[idx];
            document.getElementById('outerFunc').value = ex.outer;
            document.getElementById('innerFunc').value = ex.inner;
            document.getElementById('lowerBound').value = ex.a;
            document.getElementById('upperBound').value = ex.b;
            
            setAxis(ex.axis);
            // UI Update
            document.querySelectorAll('.axis-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.axis-btn')[ex.axis==='x'?0:1].classList.add('active');
            
            setMethod(ex.method);
            // UI Update
            document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.method-btn')[ex.method==='disk'?0:1].classList.add('active');
            
            cachedSolidData = { exactResult: ex.exact };
            generateSolid();
        }

        function prepareSolidData() {
            const outerFunc = document.getElementById('outerFunc').value;
            const innerFunc = document.getElementById('innerFunc').value;
            const res = parseInt(document.getElementById('resolution').value);
            const a = parseBoundary(document.getElementById('lowerBound').value);
            const b = parseBoundary(document.getElementById('upperBound').value);
            if (a >= b) throw new Error('ä¸‹ç•Œå¿…é ˆå°æ–¼ä¸Šç•Œ');

            let exactStr = null;
            examples.forEach(ex => {
                if (ex.outer === outerFunc && ex.inner === innerFunc && 
                    Math.abs(parseBoundary(ex.a) - a) < 0.001 && 
                    Math.abs(parseBoundary(ex.b) - b) < 0.001 && 
                    ex.axis === currentAxis) exactStr = ex.exact;
            });

            return { outerFunc, innerFunc, a, b, res, exactResult: exactStr, aStr: document.getElementById('lowerBound').value, bStr: document.getElementById('upperBound').value, method: currentMethod, axis: currentAxis };
        }


        function calculateNumericalVolume(data, intervals) {
            const { outerFunc, innerFunc, a, b, res } = data;
            let n = Math.max(40, Math.floor(intervals || res * 6));
            if (n % 2 !== 0) n += 1;
            const h = (b - a) / n;

            const integrand = (t) => {
                let R = Math.abs(evaluateFunction(outerFunc, t));
                let r = data.method === 'washer' ? Math.abs(evaluateFunction(innerFunc, t)) : 0;
                if (!isFinite(R)) R = 0;
                if (!isFinite(r)) r = 0;
                if (r > R) [R, r] = [r, R];
                return Math.PI * Math.max(0, (R * R) - (r * r));
            };

            let sum = integrand(a) + integrand(b);
            for (let i = 1; i < n; i++) {
                sum += (i % 2 === 0 ? 2 : 4) * integrand(a + i * h);
            }
            return (h / 3) * sum;
        }

        function generateSolidWithSlices(data, limit) {
            if (solid) scene.remove(solid);
            const { outerFunc, innerFunc, a, b, res } = data;
            const segments = 40;
            const step = (b - a) / res;
            const vertices = [], indices = [], colors = [];
            let calculatedVolume = 0;

            for (let i = 0; i <= limit; i++) {
                const t = a + i * step;
                let R = Math.abs(evaluateFunction(outerFunc, t));
                let r = data.method === 'washer' ? Math.abs(evaluateFunction(innerFunc, t)) : 0;
                if (!isFinite(R)) R = 0; if (!isFinite(r)) r = 0;
                
                if (i < limit) calculatedVolume += Math.PI * (R*R - r*r) * step;

                for (let j = 0; j <= segments; j++) {
                    const theta = (j / segments) * Math.PI * 2;
                    const cos = Math.cos(theta), sin = Math.sin(theta);
                    const x = data.axis === 'x' ? t : R * cos;
                    const y = data.axis === 'x' ? R * cos : t;
                    const z = R * sin;
                    vertices.push(x, y, z);
                    
                    // æè³ªä¿®æ­£ï¼šæ›´é®®è±”çš„æ¼¸å±¤
                    const prog = i / res;
                    colors.push(0.1 + prog * 0.5, 0.3 + prog * 0.2, 0.9, 0.8);

                    if (data.method === 'washer' && r > 0.01) {
                        const ix = data.axis === 'x' ? t : r * cos;
                        const iy = data.axis === 'x' ? r * cos : t;
                        const iz = r * sin;
                        vertices.push(ix, iy, iz);
                        colors.push(0.8, 0.2, 0.2, 0.8);
                    }
                }
            }
            
            const ptsPerSlice = (segments + 1) * (data.method === 'washer' ? 2 : 1);
            for (let i = 0; i < limit; i++) {
                for (let j = 0; j < segments; j++) {
                    const base = i * ptsPerSlice + j * (data.method === 'washer' ? 2 : 1);
                    const nextBase = (i + 1) * ptsPerSlice + j * (data.method === 'washer' ? 2 : 1);
                    
                    if (data.method === 'washer') {
                        indices.push(base, nextBase, base+2);
                        indices.push(base+2, nextBase, nextBase+2);
                        indices.push(base+1, base+3, nextBase+1);
                        indices.push(base+3, nextBase+3, nextBase+1);
                    } else {
                        indices.push(base, nextBase, base+1);
                        indices.push(base+1, nextBase, nextBase+1);
                    }
                }
            }

            const geom = new THREE.BufferGeometry();
            geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 4));
            if (indices.length > 0) geom.setIndex(indices);
            geom.computeVertexNormals();
            
            // æè³ªä¿®æ­£ï¼šé«˜å…‰ã€ä¸é€æ˜åº¦
            const mat = new THREE.MeshPhongMaterial({
                vertexColors: true, side: THREE.DoubleSide,
                transparent: true, opacity: 0.75, shininess: 80, specular: 0x444444
            });
            
            solid = new THREE.Mesh(geom, mat);
            scene.add(solid);
            return calculatedVolume;
        }

        function generateSolid() {
            document.getElementById('errorMsg').style.display = 'none';
            try {
                const data = prepareSolidData();
                if (cachedSolidData && cachedSolidData.exactResult) {
                    data.exactResult = cachedSolidData.exactResult;
                    cachedSolidData = null;
                }
                generateSolidWithSlices(data, data.res);

                document.getElementById('result').style.display = 'block';
                if (data.exactResult) {
                    document.getElementById('volumeValue').textContent = data.exactResult;
                } else {
                    const vol = calculateNumericalVolume(data);
                    document.getElementById('volumeValue').textContent = vol.toFixed(6);
                }

                const v = data.axis === 'x' ? 'x' : 'y';
                const rText = data.method === 'disk' ? `[R(${v})]^2` : `([R(${v})]^2 - [r(${v})]^2)`;
                const formulaEl = document.getElementById('formulaDisplay');
                formulaEl.textContent = `$$V = \\int_{${data.aStr}}^{${data.bStr}} \\pi ${rText} d${v}$$ (æ•¸å€¼: Simpson)`;
                
                if (window.MathJax) MathJax.typesetPromise();

                cachedSolidData = data;
            } catch (e) {
                const err = document.getElementById('errorMsg');
                err.textContent = e.message; err.style.display = 'block';
            }
        }

        function startAnimation() {
            if (isAnimating && !animationPaused) return;
            try {
                if (!cachedSolidData) generateSolid();
                isAnimating = true; animationPaused = false;
                if (!animationPaused) currentSliceCount = 0;
                
                document.getElementById('animProgress').style.display = 'block';
                updateAnimBtns(true);
                
                animationInterval = setInterval(() => {
                    if (currentSliceCount <= cachedSolidData.res) {
                        // 1. ç•«åœ–
                        generateSolidWithSlices(cachedSolidData, currentSliceCount);
                        
                        // 2. æ›´æ–°é€²åº¦æ¢
                        updateProgress(currentSliceCount, cachedSolidData.res);
                        
                        currentSliceCount++;
                    } else {
                        stopAnimation();
                        generateSolid();
                    }
                }, animationSpeed);
            } catch(e) { stopAnimation(); }
        }
        
        function pauseAnimation() { isAnimating = false; animationPaused = true; clearInterval(animationInterval); updateAnimBtns(false); }
        function stopAnimation() { isAnimating = false; animationPaused = false; clearInterval(animationInterval); updateAnimBtns(false); currentSliceCount = 0; }
        function resetAnimation() { stopAnimation(); generateSolidWithSlices(cachedSolidData, 0); document.getElementById('progressFill').style.width = '0%'; }
        function updateAnimBtns(isPlaying) {
            const btns = document.querySelectorAll('.anim-btn');
            btns[0].disabled = isPlaying; btns[1].disabled = !isPlaying; btns[2].disabled = !isPlaying;
        }

        function addAxes() {
            const axes = new THREE.Group(); const len = 12;
            const mkLine = (c, p1, p2) => {
                const g = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(...p1), new THREE.Vector3(...p2)]);
                return new THREE.Line(g, new THREE.LineBasicMaterial({color:c, linewidth:2}));
            };
            axes.add(mkLine(0xff0000,[-len,0,0],[len,0,0]));
            axes.add(mkLine(0x00ff00,[0,-len,0],[0,len,0]));
            axes.add(mkLine(0x0000ff,[0,0,-len],[0,0,len]));

            const mkSprite = (txt, c, x, y, z) => {
                const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=64;
                const ctx = cvs.getContext('2d');
                ctx.font='bold 48px Arial'; ctx.fillStyle=c; ctx.fillText(txt, 10, 50);
                const tex = new THREE.CanvasTexture(cvs);
                const mat = new THREE.SpriteMaterial({map:tex});
                const sp = new THREE.Sprite(mat); sp.position.set(x,y,z); sp.scale.set(2,2,1);
                return sp;
            };
            axes.add(mkSprite('X', '#f00', len+1, 0, 0));
            axes.add(mkSprite('Y', '#0f0', 0, len+1, 0));
            axes.add(mkSprite('Z', '#00f', 0, 0, len+1));
            scene.add(axes);
            scene.add(new THREE.GridHelper(24, 24, 0xdddddd, 0xeeeeee));
        }
        
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });
        init();
    </script>
</body>
</html>
