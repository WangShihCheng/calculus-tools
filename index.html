<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªé¢æ³•é«”ç©è¦–è¦ºåŒ–</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }
        #container { width: 100vw; height: 100vh; }
        
        #controls {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.98); padding: 25px;
            border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            max-width: 450px; max-height: 90vh; overflow-y: auto;
            transition: transform 0.3s; z-index: 100;
        }
        #controls.collapsed { transform: translateX(-420px); opacity: 0.3; }
        #toggleBtn {
            position: absolute; right: -45px; top: 20px;
            width: 40px; height: 40px; background: #1e3c72;
            color: white; border: none; border-radius: 0 8px 8px 0;
            cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center;
        }
        
        /* å³ä¸‹è§’èªªæ˜é¢æ¿ (å¯ç¸®å°) */
        #info-container { position: absolute; bottom: 20px; right: 20px; z-index: 101; display: flex; flex-direction: column; align-items: flex-end; }
        #info-panel {
            background: rgba(255,255,255,0.95); padding: 20px;
            border-radius: 12px; max-width: 350px; line-height: 1.8;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); font-size: 13px;
            transition: all 0.3s; transform-origin: bottom right;
        }
        #info-panel.hidden { opacity: 0; transform: scale(0.9) translateY(20px); pointer-events: none; display: none; }
        #infoToggleBtn {
            width: 36px; height: 36px; border-radius: 50%; background: white;
            border: none; font-weight: bold; color: #1e3c72; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
        }

        h1 { color: #1e3c72; margin-bottom: 5px; font-size: 24px; }
        .type-btn { padding: 10px; border: 2px solid #ddd; background: #f9f9f9; cursor: pointer; border-radius: 6px; text-align: center; font-size: 12px; }
        .type-btn.active { background: #1e3c72; color: white; border-color: #1e3c72; }
        .section-type { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        input[type="text"] { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-family: monospace; }
        .main-btn { width: 100%; padding: 12px; background: #1e3c72; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        
        .result { background: #5c6bc0; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .result .value { font-size: 24px; font-weight: bold; }
        
        .examples { background: #e3f2fd; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .example-btn { display: inline-block; padding: 5px 10px; margin: 3px; background: white; border: 1px solid #1565c0; color: #1565c0; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        .anim-controls { background: #e8f5e9; padding: 10px; border-radius: 8px; margin-top: 20px; border: 1px solid #a5d6a7; }
        .anim-btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .anim-btn { padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .play { background: #43a047; } .pause { background: #fb8c00; } .stop { background: #e53935; }
        .progress-bar { height: 10px; background: #ccc; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .fill { height: 100%; background: #43a047; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <div id="container"></div>

    <div id="controls">
        <button id="toggleBtn" onclick="document.getElementById('controls').classList.toggle('collapsed')">â—€</button>
        <h1>ğŸ“ æˆªé¢æ³•é«”ç©è¨ˆç®—</h1>
        <p style="color:#666; font-size:13px;">Volume by Cross-Sections</p>
        
        <div class="examples">
            <span style="font-size:12px; font-weight:bold; color:#1565c0;">ğŸ“š èª²æœ¬ä¾‹é¡Œï¼š</span><br>
            <span class="example-btn" onclick="loadExample(0)">é¡Œ1: æ­£æ–¹å½¢</span>
            <span class="example-btn" onclick="loadExample(1)">é¡Œ5a: ç­‰é‚Šä¸‰è§’</span>
            <span class="example-btn" onclick="loadExample(2)">é¡Œ5b: æ­£æ–¹å½¢</span>
            <span class="example-btn" onclick="loadExample(3)">é¡Œ8b: åŠåœ“</span>
        </div>
        
        <label style="display:block; margin:10px 0 5px; font-weight:bold;">æˆªé¢å½¢ç‹€ï¼š</label>
        <div class="section-type">
            <div class="type-btn active" onclick="setType('square')">æ­£æ–¹å½¢<br>Square</div>
            <div class="type-btn" onclick="setType('triangle')">ç­‰é‚Šä¸‰è§’<br>Triangle</div>
            <div class="type-btn" onclick="setType('semicircle')">åŠåœ“<br>Semicircle</div>
        </div>
        
        <label>ä¸Šå‡½æ•¸ (Top):</label> <input type="text" id="top" value="sqrt(x)">
        <label>ä¸‹å‡½æ•¸ (Bottom):</label> <input type="text" id="bot" value="-sqrt(x)">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label>ä¸‹ç•Œ a:</label><input type="text" id="a" value="0"></div>
            <div><label>ä¸Šç•Œ b:</label><input type="text" id="b" value="4"></div>
        </div>
        <label>åˆ‡ç‰‡æ•¸ï¼š<span id="sliceDisplay">30</span></label>
        <input type="range" id="slices" min="10" max="100" value="30" style="width:100%" oninput="document.getElementById('sliceDisplay').textContent=this.value">
        
        <button class="main-btn" onclick="runSimulation()">ğŸ”„ è¨ˆç®—èˆ‡ç¹ªè£½</button>
        
        <div class="anim-controls">
            <div style="font-size:13px; font-weight:bold; color:#2e7d32;">ğŸ¬ å‹•ç•«</div>
            <div class="progress-bar"><div class="fill" id="pBar"></div></div>
            <div class="anim-btn-group">
                <button class="anim-btn play" onclick="playAnim()">æ’­æ”¾</button>
                <button class="anim-btn pause" onclick="pauseAnim()">æš«åœ</button>
                <button class="anim-btn stop" onclick="stopAnim()">åœæ­¢</button>
            </div>
        </div>

        <div id="result" class="result" style="display:none;">
            <div>é«”ç© (Volume)</div>
            <div class="value" id="volRes">0</div>
            <div id="formula" style="font-size:13px; opacity:0.9; margin-top:5px; font-family:'Times New Roman', serif;"></div>
        </div>
    </div>

    <div id="info-container">
        <button id="infoToggleBtn" onclick="document.getElementById('info-panel').classList.toggle('hidden')">?</button>
        <div id="info-panel">
            <strong>ğŸ¨ æ“ä½œèªªæ˜</strong><br>
            â€¢ <strong>å–®æŒ‡/å·¦éµï¼š</strong>æ—‹è½‰<br>
            â€¢ <strong>é›™æŒ‡/æ»¾è¼ªï¼š</strong>ç¸®æ”¾<br>
            â€¢ <strong>é›™æŒ‡/å³éµï¼š</strong>å¹³ç§»<br><br>
            <strong>ğŸ“– åŸç†</strong><br>
            $$V = \int_a^b A(x) dx$$<br>
            A(x) ç‚ºæˆªé¢é¢ç©ï¼Œå–æ±ºæ–¼å½¢ç‹€èˆ‡åº•é‚Šé•·ã€‚
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls, solid;
        let currentType = 'square';
        let animId = null;
        let isPaused = false;
        
        const examples = [
            { t:'sqrt(x)', b:'-sqrt(x)', s:'0', e:'4', type:'square', ans:'16' },
            { t:'2*sqrt(sin(x))', b:'0', s:'0', e:'pi', type:'triangle', ans:'2âˆš3' },
            { t:'2*sqrt(sin(x))', b:'0', s:'0', e:'pi', type:'square', ans:'8' },
            { t:'sqrt(x)', b:'x/2', s:'0', e:'4', type:'semicircle', ans:'Ï€/15' }
        ];

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f4f8);
            camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
            camera.position.set(8, 5, 8);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(innerWidth, innerHeight);
            document.getElementById('container').appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(5,10,7); scene.add(dl);
            
            // é€™è£¡å‘¼å«äº†æ–°çš„ addAxes å‡½å¼ (åœ“æŸ±é«”ç‰ˆæœ¬)
            addAxes();

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            window.onresize = () => {
                camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(innerWidth, innerHeight);
            };
            animate();
            runSimulation();
        }
        
        // --- é€™è£¡å°±æ˜¯é—œéµä¿®æ”¹ï¼šä½¿ç”¨ CylinderGeometry ç¹ªè£½æœ‰åšåº¦çš„è»¸ ---
        function addAxes() {
            const axes = new THREE.Group();
            const len = 12; // è»¸é•·åº¦

            // 1. å»ºç«‹æœ‰åšåº¦çš„è»¸ (CylinderGeometry)
            const createAxisLine = (color, axis) => {
                // åƒæ•¸ï¼šé ‚éƒ¨åŠå¾‘ 0.04, åº•éƒ¨åŠå¾‘ 0.04, é«˜åº¦ len*2
                const geometry = new THREE.CylinderGeometry(0.04, 0.04, len * 2, 12);
                const material = new THREE.MeshBasicMaterial({ color: color });
                const mesh = new THREE.Mesh(geometry, material);
                
                if (axis === 'x') mesh.rotation.z = -Math.PI / 2;
                if (axis === 'z') mesh.rotation.x = Math.PI / 2;
                // y è»¸é è¨­å°±æ˜¯å‚ç›´çš„
                
                return mesh;
            };

            axes.add(createAxisLine(0xff0000, 'x')); // ç´…è‰² X è»¸
            axes.add(createAxisLine(0x00ff00, 'y')); // ç¶ è‰² Y è»¸
            axes.add(createAxisLine(0x0000ff, 'z')); // è—è‰² Z è»¸

            // 2. å»ºç«‹æ–‡å­—æ¨™ç±¤ (Sprite)ï¼Œæ”¾åœ¨è»¸çš„æœ«ç«¯
            const createLabel = (txt, color, x, y, z) => {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(txt, 32, 32);
                
                const texture = new THREE.CanvasTexture(canvas);
                const material = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(material);
                sprite.position.set(x, y, z);
                sprite.scale.set(1.5, 1.5, 1);
                return sprite;
            };

            axes.add(createLabel('X', '#ff0000', len + 1, 0, 0));
            axes.add(createLabel('Y', '#00ff00', 0, len + 1, 0));
            axes.add(createLabel('Z', '#0000ff', 0, 0, len + 1));

            scene.add(axes);
            
            // 3. åŠ å…¥ç¶²æ ¼
            const grid = new THREE.GridHelper(20, 20, 0xcccccc, 0xeeeeee);
            scene.add(grid);
        }

        function animate() {
            requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera);
        }

        function setType(t) {
            currentType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function loadExample(i) {
            const ex = examples[i];
            document.getElementById('top').value = ex.t;
            document.getElementById('bot').value = ex.b;
            document.getElementById('a').value = ex.s;
            document.getElementById('b').value = ex.e;
            setType(ex.type);
            document.getElementById('volRes').dataset.exact = ex.ans; 
            runSimulation();
        }

        function getVal(expr, x) {
            try { return math.evaluate(expr.toLowerCase().replace(/ln/g,'log'), {x:x, pi:Math.PI, e:Math.E}); } 
            catch(e) { return 0; }
        }

        function createSlice(x, w, type, color) {
            const shape = new THREE.Shape();
            if(type === 'square') {
                shape.moveTo(-w/2, -w/2); shape.lineTo(w/2, -w/2);
                shape.lineTo(w/2, w/2); shape.lineTo(-w/2, w/2);
            } else if(type === 'triangle') {
                const h = w * Math.sqrt(3)/2;
                shape.moveTo(-w/2, 0); shape.lineTo(w/2, 0); shape.lineTo(0, h);
            } else { 
                shape.absarc(0,0,w/2,0,Math.PI,false);
            }
            
            const geom = new THREE.ExtrudeGeometry(shape, { depth: 0.05, bevelEnabled: false });
            geom.rotateY(Math.PI/2); 
            if(type === 'semicircle') geom.rotateX(Math.PI);
            geom.translate(x, 0, 0);
            
            // æè³ªä¿®æ­£ï¼šé€æ˜åº¦ 0.75, å¢åŠ é«˜å…‰
            return new THREE.Mesh(geom, new THREE.MeshPhongMaterial({
                color:color, transparent:true, opacity:0.75, shininess:80, specular:0x444444
            }));
        }

        function runSimulation() {
            if(solid) scene.remove(solid);
            solid = new THREE.Group(); scene.add(solid);
            
            const topF = document.getElementById('top').value;
            const botF = document.getElementById('bot').value;
            const start = getVal(document.getElementById('a').value,0);
            const end = getVal(document.getElementById('b').value,0);
            const n = parseInt(document.getElementById('slices').value);
            const dx = (end-start)/n;
            
            let vol = 0;
            
            for(let i=0; i<=n; i++) {
                const x = start + i*dx;
                const h = Math.abs(getVal(topF, x) - getVal(botF, x));
                if(h > 0.01) {
                    const mesh = createSlice(x, h, currentType, new THREE.Color().setHSL(i/n*0.8, 0.7, 0.5));
                    solid.add(mesh);
                    
                    let area = 0;
                    if(currentType === 'square') area = h*h;
                    else if(currentType === 'triangle') area = (Math.sqrt(3)/4)*h*h;
                    else area = (Math.PI/8)*h*h;
                    vol += area * dx;
                }
            }
            
            const resDiv = document.getElementById('result');
            resDiv.style.display = 'block';
            
            const exact = document.getElementById('volRes').dataset.exact;
            if(exact) {
                document.getElementById('volRes').textContent = exact;
                document.getElementById('volRes').removeAttribute('data-exact');
            } else {
                document.getElementById('volRes').textContent = vol.toFixed(4);
            }
            
            let fText = "";
            if(currentType==='square') fText="A(x) = s^2";
            else if(currentType==='triangle') fText="A(x) = \\frac{\\sqrt{3}}{4}s^2";
            else fText="A(x) = \\frac{\\pi}{8}s^2";
            
            document.getElementById('formula').textContent = `$$${fText}$$ (s = Top - Bottom)`;
            
            if(window.MathJax) MathJax.typesetPromise();
        }

        function playAnim() {
            if(animId) return;
            scene.remove(solid); solid = new THREE.Group(); scene.add(solid);
            const n = parseInt(document.getElementById('slices').value);
            let i = 0;
            isPaused = false;
            
            function loop() {
                if(isPaused) return;
                if(i > n) { stopAnim(); runSimulation(); return; } 
                
                const topF = document.getElementById('top').value;
                const botF = document.getElementById('bot').value;
                const start = getVal(document.getElementById('a').value,0);
                const end = getVal(document.getElementById('b').value,0);
                const dx = (end-start)/n;
                const x = start + i*dx;
                const h = Math.abs(getVal(topF, x) - getVal(botF, x));
                
                if(h > 0.01) {
                    solid.add(createSlice(x, h, currentType, new THREE.Color().setHSL(i/n*0.8, 0.7, 0.5)));
                }
                document.getElementById('pBar').style.width = (i/n*100)+'%';
                i++;
                animId = setTimeout(() => requestAnimationFrame(loop), 50);
            }
            loop();
        }
        function pauseAnim() { isPaused = true; clearTimeout(animId); animId=null; }
        function stopAnim() { pauseAnim(); runSimulation(); document.getElementById('pBar').style.width='0%'; }

        init();
    </script>
</body>
</html>
